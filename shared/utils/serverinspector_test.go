// SPDX-FileCopyrightText: 2026 SUSE LLC
//
// SPDX-License-Identifier: Apache-2.0

package utils

import (
	"testing"

	"github.com/uyuni-project/uyuni-tools/shared/testutils"
)

func TestServerInspectorGenerate(t *testing.T) {
	inspector := NewServerInspector()
	script, err := inspector.GenerateScript()
	if err != nil {
		t.Errorf("Unexpected error %s", err)
	}

	//nolint:lll
	expected := `
# inspect.sh, generated by mgradm
echo "uyuni_release=$(cat /etc/*release | grep 'Uyuni release' | cut -d ' ' -f3 || true)"
echo "suse_manager_release=$([ -f /etc/susemanager-release ] && sed 's/.*(\([0-9.]\+\).*/\1/g' /etc/susemanager-release || true)"
echo "libc_version=$(ldd --version | head -n1 | sed 's/^ldd (GNU libc) //')"
exit 0
`

	testutils.AssertEquals(t, "Wrongly generated script", expected, script)
}

func TestServerInspectorParse(t *testing.T) {
	content := `
uyuni_release=2024.5
suse_manager_release=5.0.0
`
	actual, err := ReadInspectData[ServerInspectData]([]byte(content))
	if err != nil {
		t.Fatalf("Unexpected error: %s", err)
	}

	testutils.AssertEquals(t, "Invalid uyuni release", "2024.5", actual.UyuniRelease)
	testutils.AssertEquals(t, "Invalid SUSE Manager release", "5.0.0", actual.SuseManagerRelease)
}
